# Flow — Интернет-магазин (Telegram бот)

## Описание проекта

Flow — это полнофункциональный Telegram бот для интернет-магазина, специализирующегося на продаже компьютерной периферии и заказе товаров с китайских площадок (Poizon, TaoBao, 1688). Бот автоматизирует процесс расчета стоимости, отслеживания заказов и взаимодействия с клиентами.

## Основной функционал

### 1. Расчет стоимости товаров

Система автоматического расчета стоимости товаров из Китая с учетом:
- Курса юаня к рублю (настраивается администратором)
- Курса доллара для расчета доставки
- Веса товара (с подсказками по стандартным весам)
- Комиссии магазина (прогрессивная шкала в зависимости от стоимости товара)
- Стоимости доставки (7$ за килограмм)

Пользователь вводит стоимость товара в юанях и вес, после чего получает детальный расчет с разбивкой на стоимость товара, доставку и итоговую сумму.

### 2. Отслеживание заказов

Система отслеживания с 7 статусами:
- В обработке
- Выкуплен
- На складе в Китае
- В пути на таможню
- Таможня
- На складе в Москве
- Доставлен

Каждый статус имеет свой цвет в Google Таблице для визуального контроля. Пользователи могут отслеживать свои заказы по трек-номеру, видя полную информацию о товарах, включая фото (до 5 фото на товар).

### 3. Программа лояльности

Система начисления баллов за выполнение заданий:
- Оставить отзыв с фото (333 балла)
- Оставить видео-отзыв (500 баллов)
- Пригласить трех друзей (300 баллов)
- Заказать три любых товара (500 баллов)
- Сумма всех заказов 10.000₽ (500 баллов)

Администратор может настраивать индивидуальные списки заданий для пользователей. Каждый балл равен 1 рублю и может быть использован при оплате заказа.

### 4. Услуги моддинга клавиатур

Каталог услуг с описанием и ценами:
- Смазка свитчей (37₽ за шт.)
- Глубокая чистка клавиатуры (1390₽)
- Шумоизоляция корпуса (990₽)
- Комплексная доработка стабилизаторов (1290₽)
- Полная сборка кастома (2990₽)

Каждая услуга имеет описание, фото и возможность оформления заказа прямо из бота.

### 5. Админ-панель

Полнофункциональная админ-панель для управления магазином:
- Управление заказами: добавление, редактирование статусов, изменение сумм
- Управление товарами: добавление товаров с фото, редактирование, удаление
- Управление курсами валют: настройка курсов юаня и доллара
- Статистика бота: количество пользователей, активных за 24 часа, заказов
- Рассылки: массовая отправка сообщений всем пользователям
- Отправка сообщений конкретным пользователям по @username
- Управление программой лояльности: начисление/списание баллов, настройка заданий

## Технические решения

### Архитектура

Бот построен на асинхронной архитектуре с использованием:
- **aiogram 3.22.0** — современный фреймворк для Telegram ботов
- **aiosqlite 0.21.0** — асинхронная работа с базой данных SQLite
- **gspread 6.2.1** — интеграция с Google Sheets API

### База данных

SQLite база данных с следующей структурой:

**users** — информация о пользователях:
- user_id (PRIMARY KEY)
- username, first_name, last_name
- joined_at (дата регистрации)

**tracks** — заказы:
- id (PRIMARY KEY)
- track_number (UNIQUE)
- status (статус заказа)
- total_price (сумма заказа)
- user_id (FOREIGN KEY → users)

**items** — товары в заказах:
- id (PRIMARY KEY)
- track_id (FOREIGN KEY → tracks, CASCADE DELETE)
- name (наименование)
- description (комплектация)

**item_photos** — фото товаров:
- id (PRIMARY KEY)
- item_id (FOREIGN KEY → items, CASCADE DELETE)
- file_id (Telegram file_id, до 5 фото на товар)

**user_loyalty** — программа лояльности:
- user_id (PRIMARY KEY)
- points (баллы)
- tasks_text (индивидуальный список заданий)

**settings** — настройки системы:
- key (PRIMARY KEY)
- value (значение: курсы валют и др.)

**settings_loyalty** — настройки лояльности:
- key (PRIMARY KEY)
- value (дефолтный список заданий)

### Интеграция с Google Sheets

Автоматическая синхронизация данных о заказах с Google Таблицей:
- При изменении статуса заказа данные автоматически обновляются в таблице
- Цветовая индикация статусов для удобства визуального контроля
- Столбцы: Трек-номер, Статус, Сумма, ID Пользователя, Логин, Дата обновления
- Поддержка добавления новых заказов и обновления существующих

### Состояния (FSM)

Использование конечного автомата состояний для управления диалогами:
- CalculateState — процесс расчета стоимости
- TrackOrderState — отслеживание заказа
- AdminSettings — настройки администратора
- AdminAddItem — добавление товаров
- AdminEditItem — редактирование товаров
- AdminTrack — редактирование заказов
- LoyaltyAdmin — управление лояльностью

### Безопасность

- Проверка прав администратора перед выполнением административных команд
- Валидация входных данных (курсы валют, суммы, количества)
- Защита от SQL-инъекций через параметризованные запросы
- Обработка ошибок и логирование

## Особенности реализации

1. **Асинхронность**: Все операции с базой данных и API выполняются асинхронно для обеспечения высокой производительности
2. **Каскадное удаление**: При удалении заказа автоматически удаляются все связанные товары и фото
3. **Гибкая система заданий**: Администратор может настраивать индивидуальные списки заданий для пользователей
4. **Визуальная обратная связь**: Цветовая индикация статусов в Google Таблице
5. **Масштабируемость**: Легко добавлять новые статусы, услуги, задания

## Результаты

- 400+ довольных клиентов
- 200+ отзывов
- Полная автоматизация процесса заказа и отслеживания
- Интеграция с Google Sheets для удобного управления заказами
- Программа лояльности повышает вовлеченность клиентов
