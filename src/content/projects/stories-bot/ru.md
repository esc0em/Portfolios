# Хранитель историй — Telegram бот для анонимного сбора историй

## Описание проекта

Telegram-бот для анонимного приёма личных историй в рамках проекта «Миллион нерассказанных историй». Пользователи доверяют боту свои истории, которые после анонимизации отправляются модераторам для публикации в канале и возможного использования в сценариях короткометражных фильмов и новелл.

## Основной функционал

### 1. Пошаговый сценарий (FSM)

- **Приветствие** — знакомство с ботом, объяснение условий безопасности и анонимности.
- **Согласие с правилами** — подтверждение возраста 18+, условий публикации, согласие на использование истории в сценариях.
- **Ввод истории** — пользователь пишет текст в одном или нескольких сообщениях.
- **Подтверждение окончания** — кнопка «Да, история закончена».
- **Подтверждение отправки** — финальное согласие перед отправкой модераторам.
- **Благодарность** — сообщение об успешной отправке и приглашение подписаться на канал.

### 2. Анонимизация текста

Перед отправкой модераторам автоматически скрываются:

- Телефоны (любой формат)
- Email
- @username
- Ссылки (включая t.me)

Все перечисленные фрагменты заменяются на «[контакт удалён]».

### 3. Рассылка модераторам

Отправка историй в группу модераторов с поддержкой топиков (`message_thread_id`) для удобной организации обсуждений.

### 4. Меню

- Правила — свод правил проекта
- Как это работает — описание процесса
- О проекте — информация о «Миллионе нерассказанных историй»
- Ссылка на канал — переход в канал
- PDF-документы: свод правил, пользовательское соглашение, политика конфиденциальности

### 5. Навигация

- Кнопки «Назад», «Меню», «Начать сначала» в зависимости от контекста.
- После отказа от отправки — выбор: «Отправить сейчас» или «Переписать историю».

## Технические решения

### Стек

- **Python 3.13** — основной язык.
- **aiogram 3.x** — Telegram Bot API, FSM, клавиатуры.
- **python-dotenv** — конфигурация из .env (токен бота, ID чата модераторов, ID топика, ссылка на канал, пути к PDF).

### FSM

Использование `MemoryStorage` для состояний сценария. Состояния определяются в `states/story.py`.

### Анонимизация

Модуль `utils/anonymizer.py`:

- Regex-паттерны для телефонов, email, @username, URL.
- Функция `split_for_telegram()` — разбиение длинных текстов (>4096 символов) на части для отправки в Telegram.

### Деплой

- PowerShell-скрипт `upload_to_server.ps1` — автоматическая загрузка файлов на сервер.
- systemd-сервис `stories-bot.service` — запуск бота как демона.

## Особенности реализации

1. **Без базы данных** — бот не хранит истории, только передаёт их модераторам после анонимизации.
2. **Гибкие пути к PDF** — поддержка настройки путей к документам через переменные окружения с fallback на файлы по умолчанию в папке `files/`.
3. **Topic-based модерация** — отправка в топик группы для структурированного обсуждения.
4. **Команда /get_chat_id** — вспомогательная команда для получения ID группы.

## Результаты

- Анонимный сбор личных историй с защитой персональных данных.
- Пошаговый сценарий с подтверждением правил и условий.
- Удобная модерация через топики в группе.
- Меню с правилами и юридическими документами (PDF) для прозрачности проекта.
