# AUTOKING — бот студии детейлинга

## Описание проекта

AUTOKING — Telegram-бот для студии детейлинга. Клиенты записываются на услуги через бота: выбирают услугу, дату и время, оставляют имя и телефон. Бот ведёт каталог услуг с прайсами по классам авто, интегрирован с Google Calendar и Google Таблицами, отправляет короткие SMS-напоминания за 24 часа и за 2 часа до визита. Админ-панель реализована на кнопках: просмотр и управление бронированиями, блокировка слотов.

## Основной функционал

### 1. Запись на услугу

- Выбор услуги из списка (бронирование плёнкой, тонировка, полировка/керамика/химчистка, антихром, цветной полиуретан, брендирование и др.).
- Для части услуг — уточнение категории (например, химчистка: полная, потолок, сиденья и т.д.) с прайсом по классу авто (седан, паркетник, джип/минивэн).
- Выбор даты из доступных дней (до 5 дней вперёд) и времени из свободных слотов (рабочий день 10:00–20:00, слот 1 час).
- Ввод имени и телефона; опционально — согласие на SMS-напоминание.
- Подтверждение записи; создание события в Google Calendar и строки в Google Таблице.

### 2. Моя запись

Просмотр текущей записи пользователя: услуга, дата и время, возможность отменить запись (с удалением события в календаре).

### 3. Услуги и цены

- Каталог категорий: бронирование плёнкой, тонировка, полировка/керамика/химчистка, антихром, цветной полиуретан, брендирование, химчистка (прайс), комплексная мойка (прайс).
- Описания с ориентировочными ценами; для прайсов — выбор класса авто и вывод таблицы цен по услугам (с разбивкой на части при длинном тексте для лимитов Telegram).

### 4. Контакты и карты

Адрес студии, телефон, кнопки с ссылками на маршрут: Google Maps, Яндекс.Карты, 2ГИС.

### 5. Админ-панель

- Доступ по списку Telegram ID администраторов.
- Просмотр бронирований, отмена записей (с удалением события в календаре).
- Создание записи от имени клиента (имя, телефон, услуга, дата/время).
- Блокировка слотов по дате и времени (отдельная таблица blocked_slots).

### 6. Напоминания по SMS

- APScheduler: проверка предстоящих визитов.
- За 24 часа и за 2 часа до визита — отправка короткого SMS (≤40 символов) через SMS.Ru с датой и временем записи.

## Технические решения

### Стек

- **Python** — основной язык.
- **aiogram 3.x** — Telegram Bot API, FSM, клавиатуры.
- **SQLite** — хранение бронирований и заблокированных слотов (WAL, индексы, миграции колонок).
- **Google Sheets API** — добавление заявки в таблицу (дата создания, имя, телефон, услуга, дата/время визита, TG ID).
- **Google Calendar API** — создание и удаление событий бронирований (слот 1 час, локальный часовой пояс).
- **APScheduler** — отложенные задачи для SMS-напоминаний.
- **SMS.Ru** (requests) — отправка SMS.

### База данных

**bookings** — бронирования:
- id, user_id, service, datetime_text, visit_at_machine, client_name, phone, notify_sms, created_by_admin, calendar_event_id, created_at, canceled, reminded_24h, reminded_2h.

**blocked_slots** — заблокированные слоты:
- date_iso, time_hm (UNIQUE).

Индексы по часто используемым полям (canceled, visit_at_machine; user_id, canceled; date_iso, time_hm). При добавлении новых колонок в конфигурации выполняется миграция через PRAGMA table_info и ALTER TABLE.

### FSM

- **BookingForm** — цепочка состояний записи: выбор услуги (и при необходимости категории/пункта прайса), даты, времени, имени, телефона, канала напоминания.
- **AdminBlock** — блокировка слотов (ввод даты).

### Интеграции

- При создании бронирования: запись в SQLite, создание события в Google Calendar, добавление строки в Google Таблицу.
- При отмене: обновление/отметка в БД, удаление события из календаря.
- Напоминания: выборка предстоящих визитов из БД, отправка SMS, проставление флагов reminded_24h / reminded_2h.

## Особенности реализации

1. **Короткие SMS**: текст до 40 символов для совместимости с тарифами и правилами SMS.Ru.
2. **Локальное время**: все слоты и напоминания в часовом поясе студии (настраивается в конфиге).
3. **Свободные слоты**: учёт существующих бронирований и заблокированных слотов; для текущего дня — только будущие часы.
4. **Админ-панель на кнопках**: без отдельного веб-интерфейса, всё управление в Telegram.

## Результаты

- Автоматизация записи на услуги детейлинга без звонков.
- Меньше пропусков визитов за счёт напоминаний за 24 ч и за 2 ч.
- Единый календарь и таблица заявок для студии.
- 8+ категорий услуг, 3 внешние интеграции (Calendar, Sheets, SMS).
